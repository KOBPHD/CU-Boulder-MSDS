---
title: "NYPD Shooting Incident Data"
author: "Kevin O'Brien"
date: "2022/FEB/12"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Analysis of NYPD shooting incident data (retrieved from <https://catalog.data.gov/dataset/nypd-shooting-incident-data-historic>) for Data Science as a Field class project.

#### Library Importation
```{r library_import, echo = TRUE}
library(tidyverse)
library(dplyr)
library(readr)
library(knitr)
library(lubridate)
library(forecast)
```

#### Data Importation
```{r data_import, echo = TRUE}
# shooting_data = read_csv("NYPD_Shooting_Incident_Data_Historic.csv")
shooting_data = read_csv("https://data.cityofnewyork.us/api/views/833y-fsy8/rows.csv")
```

#### Dropping Variables
Since it's 2022, I'm not going to analyze demographic variables unless I'm either explicitly told to do so for an assignment or being paid to do so.
```{r demo_drop, echo=TRUE}
shooting_data = select(shooting_data, -c(PERP_AGE_GROUP,PERP_RACE,PERP_SEX,VIC_AGE_GROUP,VIC_RACE,VIC_SEX))
```
Dropping additional variables which aren't used for visualizations or analyses.
```{r other_drop, echo=TRUE}
shooting_data = select(shooting_data, -c(INCIDENT_KEY,OCCUR_TIME,X_COORD_CD,Y_COORD_CD,Latitude,Longitude,Lon_Lat))
```

#### Build Tables
I'm curious if the proportion of shootings that are classified as murders varies by borough or police precinct.
```{r count_prop_tables, echo=TRUE}
murder_bool_by_borough <- shooting_data %>%
  count(STATISTICAL_MURDER_FLAG, BORO) %>%
  group_by(BORO) %>%
  mutate(prop = prop.table(n))
kable(murder_bool_by_borough, caption = "Murder Determination by Borough")

murder_bool_by_precinct <- shooting_data %>%
  count(STATISTICAL_MURDER_FLAG, PRECINCT) %>%
  group_by(PRECINCT) %>%
  mutate(prop = prop.table(n))
kable(murder_bool_by_precinct, caption = "Murder Determination by Precinct")
```

#### Analysis and Visualization by Borough
```{r by_borough, echo = TRUE, out.width = "100%"}
borough_count_bin <- pivot_wider(subset(murder_bool_by_borough, select = -c(prop)), names_from = "STATISTICAL_MURDER_FLAG", values_from="n")
names(borough_count_bin) <- c("Borough", "Non-Murder", "Murder")
#This table is omitted to save output space because it contains a subset of information from an earlier table, but it's what I would include if it weren't appropriate to include the exploratory table with proportions.
#kable(borough_count_bin, caption = "Murder vs Non-Murder Counts by Borough")

borough_count_bin_bar <- as.data.frame(t(as.matrix(borough_count_bin)))
colnames(borough_count_bin_bar) <- borough_count_bin_bar[1,]
borough_count_bin_bar <- borough_count_bin_bar[-1,]

barplot(as.matrix(borough_count_bin_bar), xlab = "Borough", ylab = "Recorded Shootings", main = "NYC Shootings (2016-2020)", legend = c("Non-Murder", "Murder"), col = c("darkblue", "red"), cex.names = 0.7)

# chisq.test(borough_count_bin[,c("Murder", "Non-Murder")])
chisq.test(as.matrix(borough_count_bin[,c("Murder", "Non-Murder")]))

```
Although a bar plot is a useful tool for identifying potentially interesting differences between groups, a chi-square test returning a p-value that high doesn't suggest there are significant differences in the proportions of shootings that are classified as murders between boroughs.

#### Analysis and Visualization by Precinct
```{r by_precinct, echo=TRUE, out.width = "100%"}
precinct_count_bin <- pivot_wider(subset(murder_bool_by_precinct, select = -c(prop)), names_from = "STATISTICAL_MURDER_FLAG", values_from="n")
names(precinct_count_bin) <- c("Precinct", "Non-Murder", "Murder")
#NAs generated by the proportion conversion are converted to zeros.
precinct_count_bin[is.na(precinct_count_bin)] <- 0
#This table is omitted to save output space because it contains a subset of information from an earlier table, but it's what I would include if it weren't appropriate to include the exploratory table with proportions.
#kable(precinct_count_bin, caption = "Murder vs Non-Murder Counts by Precinct")

precinct_count_bin_bar <- as.data.frame(t(as.matrix(precinct_count_bin)))
colnames(precinct_count_bin_bar) <- precinct_count_bin_bar[1,]
precinct_count_bin_bar <- precinct_count_bin_bar[-1,]

barplot(as.matrix(precinct_count_bin_bar), xlab = "Precinct", ylab = "Recorded Shootings", main = "NYC Shootings (2016-2020)", legend = c("Non-Murder", "Murder"), col = c("darkblue", "red"), cex.names = 0.25, las=2)

chisq.test(precinct_count_bin[,c("Murder", "Non-Murder")])
```
There are statistically significant differences in the proportion of shootings that are designated as murders by precinct, but this may be driven by the very small total number of shootings in some precincts. Deciding whether or not it'd be appropriate to drop certain precincts and repeat the analysis would require additional information, which may not be conveniently aggregated or even recorded. An example scenario of a potential outlier worth discarding would be if a police precinct exclusively covered a controlled-access area, such as airport or a shipping yard. Likely, making good judgments for precincts to exclude would require conferring with someone who is familiar with the geographic boundaries for each police precinct.

#### Time Series Model
Create a count of shootings by month across the entirety of NYC and analyze it as time series data.
```{r time_series, echo=TRUE, out.width = "100%"}
shooting_data["OCCUR_DATE"] <- as.Date(shooting_data$OCCUR_DATE, "%m/%d/%Y")

shooting_data_ts_prep <- shooting_data %>% 
  group_by(month = floor_date(OCCUR_DATE, "month")) %>%
  count(month)

shooting_data_ts <- ts(shooting_data_ts_prep$n, start = c(2016,1), end = c(2020,12), frequency = 12)
plot.ts(shooting_data_ts, xlab = "Time", ylab = "Total Shootings Per Month", main = "NYC Shooting Incidents 2016 JAN - 2020 DEC")
fit_arima <- auto.arima(shooting_data_ts)
summary(fit_arima)
shooting_forecast <- forecast(fit_arima, level = c(95), h=2*12)
plot(shooting_forecast, xlab = "Time", ylab = "Total Shootings Per Month")
```
Time series modeling of total shootings by month shows a fairly strong annual cyclic pattern.
The frequency of violent crime tends to be positively correlated with ambient temperature in most regions, so, unsurprisingly, NYC (like most regions of the northern hemisphere) has rising numbers of shootings leading into summer and a decline leading into winter.
The fit ARIMA (Auto-Regressive Integrated Moving Average) model was then used for forecasting and the plot shows 95% confidence intervals on the predictions for the two following years (i.e. 2021 and 2022).
Forecasting accuracy could be assessed with the 2021 data when it's made publicly available.

#### Additionally Raised Questions
Along with the above questions regarding potential outliers in the by-precinct analysis, the questions which most immediately pop out are:
* Do by-borough differences appear if shootings are assessed per-capita rather by total count? This gets tricky because number of residents in a borough may wildly differ from the number of people in a borough by day considering how much commuting occurs in NYC.
* Are precinct boundaries appropriate given how variable the cumulative number of shooting per precinct are? Is this associated with the number of officers per precinct either as a result or as a cause?
* How accurate are the monthly estimates for 2021 from the ARIMA model?

#### Bias Identification and Mitigation
I am fully aware that I have a strong general bias against NYC.
Part of that bias stems from my complete disagreement with both city-level and state-level firearms policies covering NYC.
To minimize the impact of my personal biases on my analyses, I chose grouping variables (i.e. borough and police precinct) for which I have little to no personal opinions. (I actually have no clue where any particular police precinct is located.)
There are additional variables I immediately chose to exclude because I am personally uncomfortable with the highly politicized nature surrounding many analytical examinations of demographic variables. (Additionally, I find the binning of chronological age to be bothersome because it creates artificial cohorts and converts a ratio variable into an ordinal variable which is a form of data loss.)
If these analyses were for anything more than a class assignment, I would likely request input from someone who has previously spent a significant amount of time in NYC to determine if I have any additional blind-spots or biases which would need to be addressed.
(Additionally, as a responsible firearm owner, I'm strongly opposed to any non-defensive shooting of people, but I would sincerely hope that's a common sentiment rather than a personal bias.)

#### Session Information
The output of sessionInfo() is included for additional documentation/reproducibility.
```{r sessioninfo, echo=TRUE}
sessionInfo()
```